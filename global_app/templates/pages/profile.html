{% extends 'components/index.html' %}
{% load static %}

{% block extra_head %}
<link rel="stylesheet" href="{% static 'css/home.css' %}">
<link rel="stylesheet" href="{% static 'css/profile.css' %}">

{% endblock %}

{% block content %}

<section class="container py-5">
  <!-- Card principal do perfil -->
  <div class="feature-card p-5 mb-4 profile-header position-relative">
    <div class="row g-3 align-items-center justify-content-center">
      <div class="col-12 col-md-auto">
        <div class="avatar-lg overflow-hidden rounded-3 mx-auto">
          {% if profile.avatar %}
            <img src="{{ profile.avatar.url }}" alt="avatar" class="img-fluid">
          {% else %}
            <i class="bi bi-person-fill text-white icon-perfil"></i>
          {% endif %}
        </div>
      </div>

      <div class="col">
        <div class="small text-muted text-center text-md-start">Meu perfil</div>
        <div class="h4 mb-0 fw-bold text-center text-md-start">{{ user.get_full_name|default:user.username }}</div>
        <div class="small text-muted text-center text-md-start">#{{ profile.uid|default:user.id }}</div>

        <div class="mt-3 d-flex align-items-center gap-2 justify-content-center justify-content-md-start">
          <!-- Redes sociais -->
          {% for social in profile.socials %}
            <a href="{{ social.url }}" class="d-inline-flex align-items-center justify-content-center social-dot" target="_blank" rel="noopener">
              <i class="{{ social.icon_class }}"></i>
            </a>
          {% empty %}
            <div class="social-dot-placeholder d-flex gap-2">
              <a class="social-dot d-flex align-items-center justify-content-center text-primary fs-3"><i class="bi bi-facebook"></i></a>
              <a class="social-dot d-flex align-items-center justify-content-center text-primary fs-3"><i class="bi bi-instagram"></i></a>
              <a class="social-dot d-flex align-items-center justify-content-center text-primary fs-3"><i class="bi bi-linkedin"></i></a>
            </div>
          {% endfor %}
        </div>
      </div>

      <div class="col-auto ms-auto">
          <!-- Botão de editar -->
        <a href="#" class="btn btn-outline-secondary rounded-circle btn-edit" title="Editar perfil">
          <i class="bi bi-pencil-fill"></i>
        </a>
      </div>
    </div>
  </div>

  <div class="row g-4">
    <div class="col-lg-8">
      <!-- Abas do perfil -->
      <div class="d-flex gap-3 mb-4 flex-wrap">
        <div class="quick-box flex-fill p-4"><i class="bi bi-heart-fill text-danger me-2"></i>Postagens curtidas</div>
        <div class="quick-box flex-fill p-4"><i class="bi bi-chat-fill text-primary me-2"></i>Minhas postagens</div>
        <div class="quick-box flex-fill p-4"><i class="bi bi-telephone-fill text-success me-2"></i>Histórico de chamadas</div>
      </div>

      <!-- Configurações -->
      <h6 class="mb-3">Configurações</h6>
      
      <!-- Seção: Configurações -->
      <div class="settings-section">
        <div class="settings-header p-4 d-flex align-items-center justify-content-between" data-bs-toggle="collapse" data-bs-target="#settingsContent">
          <div class="d-flex align-items-center gap-3">
            <i class="bi bi-gear-fill fs-5"></i>
            <div class="fw-semibold">Configurações</div>
          </div>
          <i class="bi bi-chevron-right chevron-icon"></i>
        </div>
        <div class="collapse settings-content" id="settingsContent">
          <div class="p-4 border-top">
            <div class="d-flex justify-content-between align-items-center">
              <div>
                <div class="fw-semibold mb-1">Modo Escuro</div>
                <div class="small text-muted">Ativa o tema escuro em todo o site</div>
              </div>
              <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" role="switch" id="darkModeSwitch" 
                       {% if profile.dark_mode %}checked{% endif %}>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Seção: Segurança -->
      <div class="settings-section">
        <div class="settings-header p-4 d-flex align-items-center justify-content-between" data-bs-toggle="collapse" data-bs-target="#securityContent">
          <div class="d-flex align-items-center gap-3">
            <i class="bi bi-shield-fill fs-5"></i>
            <div class="fw-semibold">Segurança</div>
          </div>
          <i class="bi bi-chevron-right chevron-icon"></i>
        </div>
        <div class="collapse settings-content" id="securityContent">
          <div class="p-4 border-top">
            <!-- Autenticação de 2 fatores -->
            <div class="mb-4">
              <div class="d-flex justify-content-between align-items-center mb-3">
                <div>
                  <div class="fw-semibold mb-1">Autenticação de 2 Fatores</div>
                  <div class="small text-muted">Adicione uma camada extra de segurança à sua conta</div>
                </div>
                <span class="badge bg-danger">Desativado</span>
              </div>
              <button class="btn btn-outline-primary btn-sm">Configurar</button>
            </div>
            
            <!-- Dispositivos conectados -->
            <div>
              <div class="fw-semibold mb-3">Dispositivos Conectados</div>
              <div class="device-card current-device">
                <div class="d-flex align-items-center justify-content-between">
                  <div class="d-flex align-items-center gap-3">
                    <i class="bi bi-laptop fs-3 text-success"></i>
                    <div>
                      <div class="fw-semibold">Dispositivo Atual</div>
                      <div class="small text-muted">
                        <span id="browserInfo">Navegador desconhecido</span> • 
                        <span id="osInfo">Sistema desconhecido</span>
                      </div>
                      <div class="small text-muted">Último acesso: <span id="lastAccess">Agora</span></div>
                    </div>
                  </div>
                  <span class="badge bg-success">Ativo</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Seção: Acessibilidade -->
      <div class="settings-section">
        <div class="settings-header p-4 d-flex align-items-center justify-content-between" data-bs-toggle="collapse" data-bs-target="#accessibilityContent">
          <div class="d-flex align-items-center gap-3">
            <i class="bi bi-person-standing fs-5"></i>
            <div class="fw-semibold">Acessibilidade</div>
          </div>
          <i class="bi bi-chevron-right chevron-icon"></i>
        </div>
        <div class="collapse settings-content" id="accessibilityContent">
          <div class="p-4 border-top">
            <!-- V-Libras -->
            <div class="mb-4 pb-3">
              <div class="d-flex justify-content-between align-items-center">
                <div>
                  <div class="fw-semibold mb-1">V-Libras</div>
                  <div class="small text-muted">Tradutor de Libras para português</div>
                </div>
                <div class="form-check form-switch">
                  <input class="form-check-input" type="checkbox" role="switch" id="vlibrasSwitch"
                         {% if profile.vlibras_enabled %}checked{% endif %}>
                </div>
              </div>
            </div>
            
            <!-- Tamanho de fonte -->
            <div>
              <div class="fw-semibold mb-2">Tamanho da Fonte</div>
              <div class="small text-muted mb-3">Ajuste o tamanho do texto em todo o site</div>
              <div class="btn-group w-100" role="group">
                <input type="radio" class="btn-check" name="fontSize" id="fontSmall" value="small" 
                       {% if profile.font_size == 'small' %}checked{% endif %}>
                <label class="btn btn-outline-primary" for="fontSmall">
                  <i class="bi bi-type"></i> Pequeno
                </label>

                <input type="radio" class="btn-check" name="fontSize" id="fontMedium" value="medium"
                       {% if profile.font_size == 'medium' %}checked{% endif %}>
                <label class="btn btn-outline-primary" for="fontMedium">
                  <i class="bi bi-type"></i> Médio
                </label>

                <input type="radio" class="btn-check" name="fontSize" id="fontLarge" value="large"
                       {% if profile.font_size == 'large' %}checked{% endif %}>
                <label class="btn btn-outline-primary" for="fontLarge">
                  <i class="bi bi-type"></i> Grande
                </label>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Painel lateral -->
    <aside class="col-lg-4">
      <div class="feature-card p-4 mb-4">
        <ul class="list-unstyled mb-0">
          <li><h6 class="mb-2">Ações do perfil</h6></li>
          <li><a href="#" class="d-block py-2 text-decoration-none">Tornar-se mentor</a></li>
          <li><a href="#" class="d-block py-2 text-decoration-none">Trocar de conta</a></li>
          <li><a href="#" class="d-block py-2 text-decoration-none">Ajuda</a></li>
          <li><a href="{% url 'logout' %}" class="d-block py-2 text-decoration-none text-danger">Sair da conta</a></li>
        </ul>
      </div>

      <div class="feature-card p-4">
        <h6 class="mb-2">Precisa de ajuda? Entre em contato!</h6>
        <div class="small text-muted mb-2">Suporte: email.inventado@email.com</div>
        <a href="#" class="btn btn-outline-primary">Enviar mensagem</a>
      </div>
    </aside>
  </div>
</section>

<script>
// Detectar informações do dispositivo
document.addEventListener('DOMContentLoaded', function() {
  // Detectar navegador
  const userAgent = navigator.userAgent;
  let browserName = 'Navegador desconhecido';
  
  if (userAgent.indexOf('Firefox') > -1) {
    browserName = 'Mozilla Firefox';
  } else if (userAgent.indexOf('Chrome') > -1) {
    browserName = 'Google Chrome';
  } else if (userAgent.indexOf('Safari') > -1) {
    browserName = 'Safari';
  } else if (userAgent.indexOf('Edge') > -1) {
    browserName = 'Microsoft Edge';
  }
  
  // Detectar sistema operacional
  let osName = 'Sistema desconhecido';
  if (userAgent.indexOf('Win') > -1) osName = 'Windows';
  else if (userAgent.indexOf('Mac') > -1) osName = 'macOS';
  else if (userAgent.indexOf('Linux') > -1) osName = 'Linux';
  else if (userAgent.indexOf('Android') > -1) osName = 'Android';
  else if (userAgent.indexOf('iOS') > -1) osName = 'iOS';
  
  document.getElementById('browserInfo').textContent = browserName;
  document.getElementById('osInfo').textContent = osName;
  
  // Animação do chevron
  document.querySelectorAll('.settings-header').forEach(header => {
    header.addEventListener('click', function() {
      const chevron = this.querySelector('.chevron-icon');
      chevron.classList.toggle('rotated');
    });
  });
  
  // Dark Mode Switch
  const darkModeSwitch = document.getElementById('darkModeSwitch');
  
  if (window.darkmode && window.darkmode.isActivated()) {
    darkModeSwitch.checked = true;
  }
  
  darkModeSwitch.addEventListener('change', function() {
    const isEnabled = this.checked;
    
    if (window.darkmode) {
      if (isEnabled && !window.darkmode.isActivated()) {
        window.darkmode.toggle();
        location.reload(true);
      } else if (!isEnabled && window.darkmode.isActivated()) {
        window.darkmode.toggle();
        location.reload(true);
      }
    }
    
    fetch('{% url "update_dark_mode" %}', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': getCookie('csrftoken')
      },
      body: JSON.stringify({
        enabled: isEnabled
      })
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        console.log('Preferência de modo escuro salva!');
        location.reload();
      }
    })
    .catch(error => console.error('Erro:', error));
  });
  
  // V-Libras Switch
  const vlibrasSwitch = document.getElementById('vlibrasSwitch');
  vlibrasSwitch.addEventListener('change', function() {
    fetch('{% url "update_vlibras" %}', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': getCookie('csrftoken')
      },
      body: JSON.stringify({
        enabled: this.checked
      })
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        location.reload();
      }
    })
    .catch(error => console.error('Erro:', error));
  });
  
  // Font Size com type radio
  document.querySelectorAll('input[name="fontSize"]').forEach(radio => {
    radio.addEventListener('change', function() {
      fetch('{% url "update_font_size" %}', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({
          font_size: this.value
        })
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          location.reload();
        }
      })
      .catch(error => console.error('Erro:', error));
    });
  });
  
  // Função pra pegar o CSRF token
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === (name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }
});
</script>
{% endblock %}